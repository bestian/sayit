# ✅ 工程計畫

### **標題：重構 SayIt 資料流程與 Worker 架構**

### **內容說明**

這次重構主要針對 SayIt 的資料管線、 worker 執行模式、以及 admin 端的舊流程做全面性整理與更新。舊版流程在檔案來源、欄位定義、任務分派與 worker 執行順序上都有混亂與耦合問題，造成難以維護與除錯。此次 PR 的目標是讓整個管線乾淨、可追蹤、可測試。

---

### **變更項目**

1. **統一資料來源格式（source unification）**
   - 統一檔案命名格式：`filename`, `id`, `type`
   - 清理舊資料格式並重新整理成一致 schema。

2. **重建資料流（data flow）**
   - 原流程雜亂難追蹤，已重新定義任務生命週期：
     `source → action → queue → worker → result`
   - 新增必要欄位（task id、file id、task type）。

3. **Admin 移除多餘頁面與舊分析流程**
   - 移除過時的 admin 頁面。
   - 完全捨棄舊版分析/匯入模式。

4. **Worker 架構重寫**
   - Worker 現在接收結構化任務：
     `{ task_id, file_id, filename, type }`
   - 移除 worker 端對舊資料格式的特殊處理。
   - 清楚區分不同類型（例如 D1, R2）的處理流程。

5. **GitHub Action 整合**
   - 新增自動任務產生與送入 queue 的 action。
   - 自動化資料檢查（linting / format validation）。

---

### **為什麼要這樣做？**

- 原本資料雜亂、欄位不完整、容易追不到來源。
- Worker 對任務理解不一致，容易爆炸。
- admin 端舊流程已經阻礙擴充，不該再維護。
- 重構後可以提高穩定性、可讀性與可追蹤性。

---

### **風險**

- 舊資料如果未清理，可能無法套進新流程。
- 需要同步更新 worker config 與 queue 格式。

---

### **測試方式**

- 用新格式產生測試檔案
- GitHub Action 自動送入一筆任務
- 確認 worker 依序處理並產生正常輸出
- 檢查欄位 id、type 全部齊全

---

# ✅ 2. Data Flow 圖（文字版）

下面用文字畫一張易懂的 Data Flow：

```
┌─────────────┐
│   Source    │   (檔案 / meta / id)
└──────┬──────┘
       │
       ▼
┌─────────────┐
│ GitHub Action│  ← 自動驗證 / 分析 / 建立任務
└──────┬──────┘
       │ 產生 task
       ▼
┌─────────────┐
│   Queue     │  (task_id, filename, file_id, type)
└──────┬──────┘
       │
       ▼
┌─────────────┐
│   Worker    │  (依 type 處理 D1 / R2 / other)
└──────┬──────┘
       │
       ▼
┌─────────────┐
│   Result    │  (輸出、報告、metadata)
└─────────────┘
```

整體就是干淨的管線：
來源 → 自動化 → 佇列 → worker → 結果。

---

# ✅ 3. 工程規格書（Engineering Spec）

## **1. 目的**

重構 SayIt 的資料處理流程，使其格式一致、任務可追蹤、worker 獨立、並能透過 GitHub Action 自動驅動。

---

## **2. 名詞定義**

- **Source**：外部輸入的檔案資料。
- **Action**：自動化檢查與任務產生器。
- **Task**：要交給 worker 的工作單位。
- **Worker**：執行 task 的處理模組。
- **Result**：worker 的產出的處理結果。

---

## **3. 資料格式（Schema）**

### 3.1 Source Item

```json
{
  "file_id": "string",
  "filename": "string",
  "type": "string",
  "metadata": {}
}
```

### 3.2 Task

```json
{
  "task_id": "string",
  "file_id": "string",
  "filename": "string",
  "task_type": "D1 | R2 | other-types",
  "created_at": "timestamp"
}
```

### 3.3 Result

```json
{
  "task_id": "string",
  "status": "success | failed",
  "output": {},
  "logs": []
}
```

---

## **4. GitHub Action 行為**

- 監控新檔案或變更
- 驗證格式
- 產生 task JSON
- 將 task 推入 queue

---

## **5. Worker 行為**

- 讀取 queue 裡的 task
- 依 `task_type` 決定處理器
- 執行後產出 result
- 回報 status + logs

---

## **6. 系統要求**

- task 必須具有完整欄位（不能少 id）
- filename 與 file_id 必須可追溯 source
- worker 不得再依賴舊資料格式

---

# ✅ 4. 可執行 Todo List（工程任務）

### **A. 資料來源整理**

- [ ] 定義新的 source schema
- [ ] 清洗舊資料
- [ ] 建立 file_id 與 filename 統一規則
- [ ] 定義所有 type（D1 / R2 等）

### **B. Data Flow 重構**

- [ ] 寫新的任務生命週期
- [ ] 建立 task schema
- [ ] 建立 result schema

### **C. GitHub Action**

- [ ] 實作檔案驗證流程
- [ ] 實作任務生成器
- [ ] 實作 queue 推送程式

### **D. Worker**

- [ ] 寫新的 worker 任務接收器
- [ ] 寫 type-based dispatcher
- [ ] 實作 D1 處理模組
- [ ] 實作 R2 處理模組
- [ ] 實作 log system

### **E. Admin**

- [ ] 移除舊分析頁面
- [ ] 移除不用的資料匯入功能

### **F. 測試**

- [ ] 加入 E2E 測試
- [ ] 加入 worker 單元測試
- [ ] Action + worker 整合測試
- [ ] 確保所有 ID 都可追蹤
